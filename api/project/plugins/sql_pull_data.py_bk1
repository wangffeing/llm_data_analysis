import pandas as pd
import py_opengauss
from taskweaver.plugin import Plugin, register_plugin
import re

@register_plugin
class SqlPullData(Plugin):
    def __call__(self, sql: str):
        db = py_opengauss.open('opengauss://og_fenxi:henz5u4wTqfR%Cu6@10.126.246.168:25400/fenxi')
        get_table = db.prepare(sql)
        result = get_table()

        pattern = r"SELECT\s+(.*?)\s+FROM"
        match = re.search(pattern, sql, re.IGNORECASE | re.DOTALL)
        columns = []
        if match:
            columns_match = match.group(1).split(",")
            columns = [col.strip().split()[-1] for col in columns_match]
        df = pd.DataFrame(result, columns=columns)

        if len(df) == 0:
            return df, (
                f"The SQL query is {sql}.\n" f"The result is empty."
            )
        else:
            return df, (
                f"The SQL query is {sql}.\n"
                f"There are {len(df)} rows in the result.\n"
                f"The first {min(5, len(df))} rows are:\n{df.head(min(5, len(df))).to_markdown()}"
            )




